---
- name: Add acmetool PPA
  apt_repository:
    repo="ppa:hlandau/rhea"

- name: Install acmetool
  apt:
    name="acmetool"

- name: Add capabilities to executable
  capabilities:
    path="/usr/bin/acmetool"
    capability="cap_net_bind_service+ep"

- name: Add acme user
  user:
    name="acme"
    shell="/usr/sbin/nologin"
    password="!"
    system=yes
    createhome=no

- name: Create directories
  file:
    path="{{item}}"
    owner="acme"
    group="acme"
    state="directory"
  with_items:
    - "/var/run/acme"
    - "/var/lib/acme"
    - "/var/lib/acme/conf"
    - "/usr/lib/acme/hooks"

- name: Copy configuration
  template:
    src="responses.j2"
    dest="/var/lib/acme/conf/responses"
    owner="acme"
    group="acme"
    mode=0644

- name: Setup acmetool
  become_user: "acme"
  become: true
  command: acmetool quickstart --batch

- name: Get hooks
  command: "ls /usr/lib/acme/hooks"
  register: hooks
  changed_when: false

- name: Remove hooks
  file:
    path="/usr/lib/acme/hooks/{{item}}"
    state="absent"
  with_items: "{{hooks.stdout_lines}}"
  when: not acmetool_enable_hooks

- name: Make hooks root-owned
  file:
    path="/usr/lib/acme/hooks"
    owner="root"
    group="root"
    recurse="true"
  when: acmetool_enable_hooks

- name: Setuid hooks
  file:
    path="/usr/lib/acme/hooks/{{item}}"
    owner="root"
    group="root"
    mode="u+s"
  with_items: "{{hooks.stdout_lines}}"
  when: acmetool_enable_hooks

- name: Add acme hooks to sudoers
  lineinfile: "dest='/etc/sudoers' line='acme ALL=(root) NOPASSWD: /usr/lib/acme/hooks/'"
  when: acmetool_enable_hooks

- name: Add acmetool redirector service
  copy:
    src="acmetool.service"
    dest="/etc/systemd/system/acmetool.service"
    owner="root"
    group="root"
    mode="0644"

- name: Reload systemctl
  command: systemctl daemon-reload

- name: Enable redirector service
  command: systemctl enable acmetool.service

- name: Start redirector service
  command: systemctl start acmetool.service

- name: Generate certificates
  become_user: "acme"
  become: true
  command: acmetool want --batch {{acmetool_domains}}
